name: Windows Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'test-gh-action'

jobs:
  build:
    name: Build and Package
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install MinGW 7.3
        uses: egor-tensin/setup-mingw@v2
        with:
          version: 7.3.0
          platform: x64

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '5.14.2'
          arch: 'win64_mingw73'
          mirror: 'http://mirrors.ocf.berkeley.edu/qt/'
          add-to-path: true

      - name: Configure CMake
        run: |
          mkdir -Force build_ci
          cd build_ci
          cmake -G "MinGW Makefiles" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_C_COMPILER=gcc `
                -DCMAKE_CXX_COMPILER=g++ `
                ..
        shell: pwsh

      - name: Build Application
        run: |
          cd build_ci
          cmake --build . --parallel
        shell: pwsh

      # ==============================================
      # 核心修改：替换为【和本地完全一致的手动打包逻辑】
      # 完全复刻你的本地release_package目录，无冗余文件
      # ==============================================
      - name: Manual Package (Same as local bash script, 100% match)
        run: |
          # 1. 准备打包目录，和本地一致
          $SOURCE_DIR = $PWD.Path
          $RELEASE_DIR = Join-Path $SOURCE_DIR "release_package"
          $BUILD_DIR = Join-Path $SOURCE_DIR "build_ci"
          $QT_DIR = $env:Qt5_DIR | Split-Path -Parent | Split-Path -Parent
          $QT_BIN_DIR = Join-Path $QT_DIR "bin"
          $QT_PLUGIN_DIR = Join-Path $QT_DIR "plugins"

          mkdir -Force $RELEASE_DIR
          Write-Host "Qt Bin Dir: $QT_BIN_DIR"
          Write-Host "Release Dir: $RELEASE_DIR"

          # 2. 拷贝可执行文件 (和你本地一样，兼容src子目录)
          $EXE_PATH = Join-Path $BUILD_DIR "src/TextBridge.exe"
          if (-not (Test-Path $EXE_PATH)) {
              $EXE_PATH = Join-Path $BUILD_DIR "TextBridge.exe"
          }
          Copy-Item -Path $EXE_PATH -Destination $RELEASE_DIR -Force
          Write-Host "✅ Copied: TextBridge.exe"

          # 3. 拷贝核心DLL（和你本地完全一样的7个，一个不多一个不少）
          $CORE_DLLS = @(
              "Qt5Core.dll",
              "Qt5Gui.dll",
              "Qt5Widgets.dll",
              "Qt5Svg.dll",
              "libgcc_s_seh-1.dll",
              "libstdc++-6.dll",
              "libwinpthread-1.dll"
          )
          foreach ($dll in $CORE_DLLS) {
              $dllSrc = Join-Path $QT_BIN_DIR $dll
              Copy-Item -Path $dllSrc -Destination $RELEASE_DIR -Force
              Write-Host "✅ Copied: $dll"
          }

          # 4. 拷贝platforms插件 (只拷贝qwindows.dll，和本地一致)
          $PLATFORM_DST = Join-Path $RELEASE_DIR "platforms"
          mkdir -Force $PLATFORM_DST
          $qwindowsSrc = Join-Path $QT_PLUGIN_DIR "platforms/qwindows.dll"
          Copy-Item -Path $qwindowsSrc -Destination $PLATFORM_DST -Force
          Write-Host "✅ Copied: platforms/qwindows.dll"

          # 5. 拷贝imageformats插件 (只拷贝qsvg.dll，和本地一致)
          $IMAGE_DST = Join-Path $RELEASE_DIR "imageformats"
          mkdir -Force $IMAGE_DST
          $qsvgSrc = Join-Path $QT_PLUGIN_DIR "imageformats/qsvg.dll"
          Copy-Item -Path $qsvgSrc -Destination $IMAGE_DST -Force
          Write-Host "✅ Copied: imageformats/qsvg.dll"

          # 6. 生成【和你本地完全一样的qt.conf】！！！关键中的关键
          $QT_CONF = Join-Path $RELEASE_DIR "qt.conf"
          @"
[Paths]
Plugins=.
"@ | Out-File -FilePath $QT_CONF -Encoding ASCII -Force
          Write-Host "✅ Created: qt.conf (Same as local)"

          # 7. 打印目录结构，和你的本地目录对比
          Write-Host "`n===== Final Package Content (Same as local) ====="
          Get-ChildItem -Recurse $RELEASE_DIR
        shell: pwsh

      - name: Create Zip Archive
        run: |
          Compress-Archive -Path release_package\* -DestinationPath TextBridge-Win64.zip -Force
        shell: pwsh

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TextBridge-Win64-Test
          path: TextBridge-Win64.zip
          retention-days: 90

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: TextBridge-Win64.zip
          body_path: README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}