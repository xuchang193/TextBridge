name: Windows Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'test-gh-action'

jobs:
  build:
    name: Build and Package
    runs-on: windows-2019 # 兼容Qt 5.14.2，也可替换为windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 新增：安装Qt 5.14.2对应的MinGW 7.3编译器（核心修复）
      - name: Install MinGW 7.3
        uses: egor-tensin/setup-mingw@v2
        with:
          version: 7.3.0
          platform: x64

      # 安装Qt：补充add-to-path确保windeployqt可被找到
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.14.2'
          arch: 'win64_mingw73'
          mirror: 'http://mirrors.ocf.berkeley.edu/qt/'
          add-to-path: true # 关键：将Qt的bin目录加入系统PATH

      # 优化CMake配置：改用PowerShell，显式指定编译器
      - name: Configure CMake
        run: |
          mkdir -Force build_ci  # PowerShell的强制创建目录
          cd build_ci
          cmake -G "MinGW Makefiles" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_C_COMPILER=gcc `
                -DCMAKE_CXX_COMPILER=g++ `
                ..
        shell: pwsh # 用PowerShell替代bash，适配Windows路径

      # 修复构建参数：移除无效的--config Release
      - name: Build Application
        run: |
          cd build_ci
          cmake --build . --parallel  # --parallel启用多线程构建，加速编译
        shell: pwsh

      # 优化打包步骤：PowerShell语法，增强容错性
      - name: Package with windeployqt
        run: |
          # 1. 准备打包目录
          mkdir -Force release_package
          Copy-Item -Path build_ci\src\TextBridge.exe -Destination release_package\ -Force
          
          # 2. 动态获取Qt路径
          $windeployqtPath = (Get-Command windeployqt).Source
          $qtBinDir = Split-Path $windeployqtPath
          $qtRootDir = Split-Path $qtBinDir
          Write-Host "Detected Qt Root: $qtRootDir"
          
          # 3. 运行 windeployqt
          # 参考成功案例：直接在 exe 目录执行，或者指定 exe 路径
          # 关键差异：成功案例中是在 exe 所在目录执行的
          
          Write-Host "Running windeployqt..."
          # 将Qt bin目录添加到Path，确保能找到依赖
          $env:Path = "$qtBinDir;$env:Path"
          
          # 使用 --dir 指定输出目录，直接对 exe 进行处理
          windeployqt release_package\TextBridge.exe --dir release_package --release --no-translations --compiler-runtime --verbose 1
          
          # 4. 验证内容并补充（如果需要）
          # 如果 windeployqt 成功，通常不需要手动复制核心 DLL，但保留作为保险
          if (-not (Test-Path release_package\Qt5Core.dll)) {
              Write-Warning "windeployqt failed to copy Qt DLLs, attempting manual copy..."
              $coreDlls = @("Qt5Core.dll", "Qt5Gui.dll", "Qt5Widgets.dll", "libgcc_s_seh-1.dll", "libstdc++-6.dll", "libwinpthread-1.dll")
              foreach ($dll in $coreDlls) {
                  $srcPath = Join-Path $qtBinDir $dll
                  if (Test-Path $srcPath) {
                      Copy-Item -Path $srcPath -Destination release_package\ -Force
                  }
              }
              
              # 手动复制 plugins
              mkdir -Force release_package/platforms
              Copy-Item -Path "$qtRootDir/plugins/platforms/qwindows.dll" -Destination release_package/platforms/ -Force
              Copy-Item -Path "$qtRootDir/plugins/platforms/qminimal.dll" -Destination release_package/platforms/ -Force
          }

          # 5. 清理垃圾文件
          Remove-Item -Path release_package\*.cpp, release_package\*.h, release_package\*.obj -ErrorAction SilentlyContinue

          # 6. 打印结果
          Write-Host "===== Package Content ====="
          Get-ChildItem -Recurse release_package
        shell: pwsh
      # 压缩打包：添加-Force覆盖已有zip
      - name: Create Zip Archive
        run: |
          Compress-Archive -Path release_package\* -DestinationPath TextBridge-Win64.zip -Force
        shell: pwsh

      # 发布到GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: TextBridge-Win64.zip
          body_path: README.md # 若无需README作为发布说明，可改为body: "Windows Release Build"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}