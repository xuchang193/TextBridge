name: Windows Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'test-gh-action'

jobs:
  build:
    name: Build and Package
    runs-on: windows-2019 # 兼容Qt 5.14.2，也可替换为windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 新增：安装Qt 5.14.2对应的MinGW 7.3编译器（核心修复）
      - name: Install MinGW 7.3
        uses: egor-tensin/setup-mingw@v2
        with:
          version: 7.3.0
          platform: x64

      # 安装Qt：补充add-to-path确保windeployqt可被找到
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '5.14.2'
          arch: 'win64_mingw73'
          mirror: 'http://mirrors.ocf.berkeley.edu/qt/'
          add-to-path: true # 关键：将Qt的bin目录加入系统PATH

      # 优化CMake配置：改用PowerShell，显式指定编译器
      - name: Configure CMake
        run: |
          mkdir -Force build_ci  # PowerShell的强制创建目录
          cd build_ci
          cmake -G "MinGW Makefiles" `
                -DCMAKE_BUILD_TYPE=Release `
                -DCMAKE_C_COMPILER=gcc `
                -DCMAKE_CXX_COMPILER=g++ `
                ..
        shell: pwsh # 用PowerShell替代bash，适配Windows路径

      # 修复构建参数：移除无效的--config Release
      - name: Build Application
        run: |
          cd build_ci
          cmake --build . --parallel  # --parallel启用多线程构建，加速编译
        shell: pwsh

      # 优化打包步骤：PowerShell语法，增强容错性
      - name: Package with windeployqt (Fixed All Bugs)
        run: |
          # ===== 【根因1修复 核心】彻底清空Qt相关环境变量，优先级最高，杜绝干扰 =====
          # 直接删除这两个环境变量，让windeployqt完全找不到系统Qt，必须自己复制依赖
          Remove-Item Env:QT_PLUGIN_PATH -ErrorAction SilentlyContinue
          Remove-Item Env:QML2_IMPORT_PATH -ErrorAction SilentlyContinue
          Remove-Item Env:Qt5_Dir -ErrorAction SilentlyContinue

          # ===== 1. 创建打包目录 + 复制编译好的exe =====
          mkdir -Force release_package
          Copy-Item -Path build_ci\src\TextBridge.exe -Destination release_package\ -Force

          # 动态获取Qt根目录，避免硬编码路径错误 (提前获取变量)
          $windeployqtPath = (Get-Command windeployqt).Source
          $qtBinDir = Split-Path $windeployqtPath
          $qtRootDir = Split-Path $qtBinDir
          Write-Host "Detected Qt Root: $qtRootDir"
          
          # ===== 2. 最优打包命令（精简无错，适配你的版本） =====
          # 尝试运行windeployqt，即使它失败或不完整，后续的手动复制会作为兜底
          # 关键修改：显式指定 windeployqt 使用我们检测到的 bin 目录，避免它去错误路径查找
          $env:Path = "$qtBinDir;$env:Path" 
          windeployqt release_package\TextBridge.exe --release --no-translations --compiler-runtime --verbose 1

          # ===== 【兜底修复】手动复制核心DLL，防止windeployqt漏文件 =====
          Write-Host "Manually copying core DLLs from $qtBinDir..."
          $coreDlls = @("Qt5Core.dll", "Qt5Gui.dll", "Qt5Widgets.dll", "libgcc_s_seh-1.dll", "libstdc++-6.dll", "libwinpthread-1.dll")
          foreach ($dll in $coreDlls) {
              $srcPath = Join-Path $qtBinDir $dll
              if (Test-Path $srcPath) {
                  Copy-Item -Path $srcPath -Destination release_package\ -Force
              } else {
                  Write-Warning "Core DLL not found: $srcPath"
              }
          }

          # ===== 【根因2修复 核心】手动复制Qt5.14.2缺失的platforms插件（必加，救命题） =====

          mkdir -Force release_package/platforms
          Copy-Item -Path "$qtRootDir/plugins/platforms/qwindows.dll" -Destination release_package/platforms/ -Force
          Copy-Item -Path "$qtRootDir/plugins/platforms/qminimal.dll" -Destination release_package/platforms/ -Force

          # ===== 3. 写入【最优稳定版】qt.conf 彻底隔离环境，防止运行时闪退 =====
          @"
          [Paths]
          Prefix = .
          Plugins = .
          Libraries = .
          Binaries = .
          "@ | Out-File -FilePath release_package\qt.conf -Encoding ASCII -Force

          # ===== 4. 清理冗余文件，容错处理 =====
          Remove-Item -Path release_package\*.cpp, release_package\*.h, release_package\*.obj -ErrorAction SilentlyContinue

          # ===== 验证：打印打包目录结构，确认所有核心文件都在 =====
          Write-Host "===== 打包目录文件清单 ====="
          Get-ChildItem -Recurse release_package
        shell: pwsh
      # 压缩打包：添加-Force覆盖已有zip
      - name: Create Zip Archive
        run: |
          Compress-Archive -Path release_package\* -DestinationPath TextBridge-Win64.zip -Force
        shell: pwsh

      # 发布到GitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: TextBridge-Win64.zip
          body_path: README.md # 若无需README作为发布说明，可改为body: "Windows Release Build"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}